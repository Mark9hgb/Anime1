<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiyo's Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
        }
        .body-overlay::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(17, 24, 39, 0.9);
            z-index: -1;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="text-gray-200 antialiased">

    <div id="app" class="min-h-screen flex flex-col p-4 md:p-8 relative">

        <!-- Header -->
        <header id="mainHeader" class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700/50">
            <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-white">Kiyo's Vault</h1>
            <div class="flex items-center space-x-2">
                 <button id="changeBgButton" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200 ease-in-out flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    BG
                </button>
                <input type="file" id="bgFile" class="hidden" accept="image/*">
                <button id="dashboardButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    Dashboard
                </button>
            </div>
        </header>

        <main class="flex-grow">
            <!-- Gallery Page -->
            <div id="galleryPage">
                <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Video thumbnails will be injected here -->
                </div>
                <div id="emptyState" class="hidden text-center py-20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-500 mb-4"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    <h2 class="text-xl font-semibold text-gray-300">Your Vault is Empty</h2>
                    <p class="text-gray-400 mt-2">Go to the Dashboard to upload your first clip.</p>
                </div>
            </div>
            
            <!-- Video Player Page -->
            <div id="playerPage" class="hidden">
                <button id="backButton" class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200 ease-in-out flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m15 18-6-6 6-6"/></svg>
                    Back
                </button>
                <div class="bg-black rounded-lg shadow-2xl overflow-hidden">
                    <video id="mainPlayer" class="w-full max-h-[75vh] aspect-video" controls autoplay></video>
                </div>
                <h2 id="playerTitle" class="text-2xl font-bold mt-4 text-center text-white"></h2>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="hidden">
                <div class="max-w-4xl mx-auto bg-gray-900/50 p-8 rounded-xl shadow-2xl border border-gray-700 backdrop-blur-sm">
                    <!-- Dashboard Header -->
                    <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700">
                        <h2 class="text-3xl font-bold text-white">Dashboard</h2>
                        <button id="backFromDashboard" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200 ease-in-out flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m15 18-6-6 6-6"/></svg>
                            Back
                        </button>
                    </div>

                    <!-- Upload Section -->
                    <div class="mb-10 pb-8 border-b border-gray-700">
                        <h3 class="text-2xl font-bold mb-6 text-white">Upload New Video</h3>
                        <form id="uploadForm">
                            <div class="space-y-6">
                                <div>
                                    <label for="videoTitle" class="block text-sm font-medium text-gray-300 mb-1">Video Title</label>
                                    <input type="text" id="videoTitle" required class="w-full bg-gray-800 border border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., 'Summer Vacation Highlights'">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Video File</label>
                                    <div id="dropZone" class="relative flex justify-center items-center w-full px-6 py-10 border-2 border-dashed border-gray-600 rounded-lg bg-gray-800 hover:border-indigo-500 hover:bg-gray-700/50 transition-colors">
                                        <div class="text-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-500 mb-2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                                            <p class="text-gray-400 mt-2"><span class="font-semibold text-indigo-400">Click to upload</span> or drag and drop</p>
                                            <p id="fileName" class="text-sm text-gray-500 mt-1"></p>
                                        </div>
                                        <input type="file" id="videoFile" accept="video/*" required class="opacity-0 absolute w-full h-full cursor-pointer top-0 left-0">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8">
                                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 duration-200 ease-in-out">Add to Vault</button>
                            </div>
                        </form>
                    </div>

                     <!-- Manage Section -->
                    <div>
                         <h3 class="text-2xl font-bold text-white mb-6">Manage Existing Videos</h3>
                         <div id="dashboardVideoList" class="space-y-3">
                            <!-- Video list items will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed bottom-5 right-5 text-white py-2.5 px-5 rounded-lg shadow-xl hidden transition-all duration-300 transform translate-y-10 opacity-0 z-50"></div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm border border-gray-700">
            <h3 class="text-lg font-bold text-white mb-2">Confirm Deletion</h3>
            <p class="text-gray-400 mb-6">Are you sure you want to permanently delete this video? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDelete" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-medium transition-colors">Cancel</button>
                <button id="confirmDelete" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition-colors">Delete</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DB_NAME = 'KiyosVaultDB';
            const DB_VERSION = 2; 
            const VIDEO_STORE = 'videos';
            const SETTINGS_STORE = 'settings';
            let db;

            const mainHeader = document.getElementById('mainHeader');
            const pageElements = {
                gallery: document.getElementById('galleryPage'),
                player: document.getElementById('playerPage'),
                dashboard: document.getElementById('dashboardPage'),
            };

            const dashboardButton = document.getElementById('dashboardButton');
            const changeBgButton = document.getElementById('changeBgButton');
            const bgFileInput = document.getElementById('bgFile');
            const backButton = document.getElementById('backButton');
            const backFromDashboard = document.getElementById('backFromDashboard');
            
            const videoGrid = document.getElementById('videoGrid');
            const emptyState = document.getElementById('emptyState');

            const uploadForm = document.getElementById('uploadForm');
            const videoFileInput = document.getElementById('videoFile');
            const fileNameDisplay = document.getElementById('fileName');
            const dropZone = document.getElementById('dropZone');
            
            const mainPlayer = document.getElementById('mainPlayer');
            const playerTitle = document.getElementById('playerTitle');
            
            const dashboardVideoList = document.getElementById('dashboardVideoList');

            const notification = document.getElementById('notification');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDelete = document.getElementById('cancelDelete');
            const confirmDelete = document.getElementById('confirmDelete');
            let videoIdToDelete = null;

            
            // --- Page Navigation ---
            function navigateTo(pageName) {
                Object.entries(pageElements).forEach(([name, el]) => {
                    el.classList.toggle('hidden', name !== pageName);
                });
                mainHeader.classList.toggle('hidden', pageName !== 'gallery');
                
                if (pageName === 'dashboard') {
                    displayDashboardVideos();
                }
            }

            // --- Notification ---
            let notificationTimeout;
            function showNotification(message, isError = true) {
                clearTimeout(notificationTimeout);
                notification.textContent = message;
                notification.classList.remove('bg-red-600', 'bg-green-600', 'hidden', 'translate-y-10', 'opacity-0');
                notification.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
                setTimeout(() => notification.classList.remove('translate-y-10', 'opacity-0'), 10);
                notificationTimeout = setTimeout(() => {
                    notification.classList.add('translate-y-10', 'opacity-0');
                    setTimeout(() => notification.classList.add('hidden'), 300);
                }, 4000);
            }

            // --- Database Functions ---
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (e) => reject('Database error: ' + e.target.errorCode);
                    request.onupgradeneeded = (e) => {
                        const dbInstance = e.target.result;
                        if (!dbInstance.objectStoreNames.contains(VIDEO_STORE)) {
                            dbInstance.createObjectStore(VIDEO_STORE, { keyPath: 'id', autoIncrement: true });
                        }
                        if (!dbInstance.objectStoreNames.contains(SETTINGS_STORE)) {
                            dbInstance.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
                        }
                    };
                    request.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };
                });
            }

            function dbAction(storeName, mode, action, data) {
                 return new Promise((resolve, reject) => {
                    if (!db) return reject('DB not open');
                    const transaction = db.transaction(storeName, mode);
                    const store = transaction.objectStore(storeName);
                    const request = store[action](data);
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(`DB ${action} error: ${e.target.error}`);
                });
            }

            // --- Background Image ---
            async function setBackground(imageFile) {
                try {
                    await dbAction(SETTINGS_STORE, 'readwrite', 'put', { key: 'background', value: imageFile });
                    applyBackground(imageFile);
                    showNotification('Background updated!', false);
                } catch(e) {
                    showNotification('Could not save background.');
                }
            }

            function applyBackground(imageFile) {
                if(imageFile) {
                    const url = URL.createObjectURL(imageFile);
                    document.body.style.backgroundImage = `url('${url}')`;
                    document.body.classList.add('body-overlay');
                } else {
                    document.body.style.backgroundImage = 'none';
                    document.body.classList.remove('body-overlay');
                }
            }
            
            async function loadBackground() {
                try {
                    const bgSetting = await dbAction(SETTINGS_STORE, 'readonly', 'get', 'background');
                    if(bgSetting) applyBackground(bgSetting.value);
                } catch(e) { /* No background set, do nothing */ }
            }

            // --- UI & Video Functions ---
            async function displayVideos() {
                const videos = await dbAction(VIDEO_STORE, 'readonly', 'getAll');
                videoGrid.innerHTML = '';
                emptyState.classList.toggle('hidden', videos.length > 0);
                
                videos.reverse().forEach(video => {
                    const videoUrl = URL.createObjectURL(video.file);
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800/80 backdrop-blur-sm rounded-lg overflow-hidden shadow-lg group border border-gray-700 cursor-pointer';
                    card.dataset.videoId = video.id;
                    card.innerHTML = `
                        <video class="w-full aspect-video object-cover bg-black pointer-events-none" src="${videoUrl}#t=0.1" preload="metadata"></video>
                        <div class="p-4"><h3 class="font-semibold text-white truncate group-hover:text-indigo-400 transition-colors">${video.title}</h3></div>
                    `;
                    videoGrid.appendChild(card);
                });
            }

            async function displayDashboardVideos() {
                const videos = await dbAction(VIDEO_STORE, 'readonly', 'getAll');
                dashboardVideoList.innerHTML = '';
                if (videos.length === 0) {
                    dashboardVideoList.innerHTML = `<p class="text-gray-500 text-center py-8">No videos to manage.</p>`;
                    return;
                }
                
                videos.reverse().forEach(video => {
                    const listItem = document.createElement('div');
                    listItem.className = 'bg-gray-800/80 p-4 rounded-lg flex justify-between items-center border border-gray-700';
                    listItem.innerHTML = `
                        <span class="text-white truncate pr-4">${video.title}</span>
                        <button data-video-id="${video.id}" class="delete-btn flex-shrink-0 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md transition-colors text-sm">Delete</button>
                    `;
                    dashboardVideoList.appendChild(listItem);
                });
            }


            async function playVideo(videoId) {
                const id = parseInt(videoId);
                const video = await dbAction(VIDEO_STORE, 'readonly', 'get', id);
                if (video) {
                    const videoUrl = URL.createObjectURL(video.file);
                    mainPlayer.src = videoUrl;
                    playerTitle.textContent = video.title;
                    navigateTo('player');
                }
            }
            
            async function deleteVideo(videoId) {
                try {
                    await dbAction(VIDEO_STORE, 'readwrite', 'delete', videoId);
                    showNotification('Video deleted successfully.', false);
                    await displayDashboardVideos();
                    await displayVideos(); 
                } catch(e) {
                    showNotification('Error deleting video.');
                }
            }

            // --- Event Listeners ---
            dashboardButton.addEventListener('click', () => navigateTo('dashboard'));
            
            backButton.addEventListener('click', () => {
                mainPlayer.pause();
                mainPlayer.src = '';
                navigateTo('gallery');
            });
            
            backFromDashboard.addEventListener('click', () => navigateTo('gallery'));

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = e.target.querySelector('#videoTitle').value.trim();
                const file = videoFileInput.files[0];
                if (!title || !file) return showNotification('Please provide a title and select a file.');
                try {
                    await dbAction(VIDEO_STORE, 'readwrite', 'add', { title, file });
                    showNotification('Video added successfully!', false);
                    uploadForm.reset();
                    fileNameDisplay.textContent = '';
                    await displayVideos();
                    await displayDashboardVideos();
                } catch(error) {
                    showNotification('Could not add video. Storage may be full.');
                }
            });

            changeBgButton.addEventListener('click', () => bgFileInput.click());
            bgFileInput.addEventListener('change', () => {
                const file = bgFileInput.files[0];
                if (file) setBackground(file);
            });

            videoGrid.addEventListener('click', (e) => {
                const card = e.target.closest('[data-video-id]');
                if (card) playVideo(card.dataset.videoId);
            });

            dashboardVideoList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    videoIdToDelete = parseInt(e.target.dataset.videoId);
                    deleteConfirmModal.classList.remove('hidden');
                }
            });

            cancelDelete.addEventListener('click', () => {
                videoIdToDelete = null;
                deleteConfirmModal.classList.add('hidden');
            });

            confirmDelete.addEventListener('click', () => {
                if (videoIdToDelete !== null) {
                    deleteVideo(videoIdToDelete);
                }
                videoIdToDelete = null;
                deleteConfirmModal.classList.add('hidden');
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.add('border-indigo-500'), false));
            ['dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.remove('border-indigo-500'), false));
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('video/')) {
                    videoFileInput.files = files;
                    fileNameDisplay.textContent = files[0].name;
                } else { showNotification('Please drop a valid video file.'); }
            }, false);
            videoFileInput.addEventListener('change', () => {
                if(videoFileInput.files.length > 0) fileNameDisplay.textContent = videoFileInput.files[0].name;
            });

            // --- Initialization ---
            async function init() {
                try {
                    await openDB();
                    await loadBackground();
                    await displayVideos();
                    navigateTo('gallery');
                } catch (error) {
                    console.error('Initialization failed:', error);
                    showNotification('Could not initialize app. Please enable IndexedDB.');
                }
            }

            init();
        });
    </script>
</body>
</html>


